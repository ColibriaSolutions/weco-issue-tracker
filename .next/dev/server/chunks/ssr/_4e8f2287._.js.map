{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///G:/SourceCode/WECORelated/weco-issue-tracker/lib/supabase/admin.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\r\nimport { Database } from '@/types/supabase'\r\n\r\nexport function createAdminClient() {\r\n    return createClient<Database>(\r\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n        process.env.SUPABASE_SERVICE_ROLE_KEY!,\r\n        {\r\n            auth: {\r\n                autoRefreshToken: false,\r\n                persistSession: false,\r\n            },\r\n        }\r\n    )\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAGO,SAAS;IACZ,OAAO,IAAA,iRAAY,gFAEf,QAAQ,GAAG,CAAC,yBAAyB,EACrC;QACI,MAAM;YACF,kBAAkB;YAClB,gBAAgB;QACpB;IACJ;AAER"}},
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///G:/SourceCode/WECORelated/weco-issue-tracker/app/actions/admin-actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { createAdminClient } from '@/lib/supabase/admin'\r\nimport { createServerClient } from '@/lib/supabase/server'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { z } from 'zod'\r\n\r\nconst createUserSchema = z.object({\r\n    email: z.string().email(),\r\n    password: z.string().min(6),\r\n    fullName: z.string().min(2),\r\n    role: z.enum(['user', 'support', 'admin']),\r\n})\r\n\r\nexport async function listUsers() {\r\n    const supabase = createAdminClient()\r\n\r\n    // Get all profiles first\r\n    const { data: profiles, error: profilesError } = await supabase\r\n        .from('profiles')\r\n        .select('*')\r\n        .order('created_at', { ascending: false })\r\n\r\n    if (profilesError) {\r\n        console.error('Error fetching profiles:', profilesError)\r\n        return { error: profilesError.message }\r\n    }\r\n\r\n    // Get auth users to match emails (since profiles might not have email if we didn't sync it perfectly, \r\n    // but usually we rely on auth.users for email. \r\n    // However, we can't join auth.users easily with client SDK.\r\n    // So we fetch all users from auth.admin and map them.)\r\n\r\n    const { data: { users }, error: authError } = await supabase.auth.admin.listUsers()\r\n\r\n    if (authError) {\r\n        console.error('Error fetching auth users:', authError)\r\n        return { error: authError.message }\r\n    }\r\n\r\n    // Merge data\r\n    const combinedUsers = profiles.map(profile => {\r\n        const authUser = users.find(u => u.id === profile.id)\r\n        return {\r\n            ...profile,\r\n            email: authUser?.email,\r\n            last_sign_in_at: authUser?.last_sign_in_at,\r\n        }\r\n    })\r\n\r\n    return { data: combinedUsers }\r\n}\r\n\r\nexport async function createUser(formData: FormData) {\r\n    const supabase = createAdminClient()\r\n\r\n    const rawData = {\r\n        email: formData.get('email'),\r\n        password: formData.get('password'),\r\n        fullName: formData.get('fullName'),\r\n        role: formData.get('role'),\r\n    }\r\n\r\n    const validated = createUserSchema.safeParse(rawData)\r\n\r\n    if (!validated.success) {\r\n        return { error: validated.error.flatten().fieldErrors }\r\n    }\r\n\r\n    const { email, password, fullName, role } = validated.data\r\n\r\n    // 1. Create Auth User\r\n    const { data: authUser, error: authError } = await supabase.auth.admin.createUser({\r\n        email,\r\n        password,\r\n        email_confirm: true, // Auto-confirm since admin is creating it\r\n        user_metadata: { full_name: fullName },\r\n    })\r\n\r\n    if (authError) {\r\n        return { error: authError.message }\r\n    }\r\n\r\n    if (!authUser.user) {\r\n        return { error: 'Failed to create user' }\r\n    }\r\n\r\n    // 2. Update Profile with Role and Force Password Reset\r\n    // The trigger creates the profile with default 'user' role. We need to update it.\r\n    const { error: profileError } = await supabase\r\n        .from('profiles')\r\n        .update({\r\n            role: role as any,\r\n            must_change_password: true,\r\n        })\r\n        .eq('id', authUser.user.id)\r\n\r\n    if (profileError) {\r\n        // Cleanup if profile update fails? Or just report error.\r\n        return { error: 'User created but failed to update profile role: ' + profileError.message }\r\n    }\r\n\r\n    revalidatePath('/admin')\r\n    return { success: true }\r\n}\r\n\r\nexport async function toggleUserStatus(userId: string, isActive: boolean) {\r\n    const supabase = createAdminClient()\r\n\r\n    // 1. Update Profile\r\n    const { error: profileError } = await supabase\r\n        .from('profiles')\r\n        .update({ is_active: isActive })\r\n        .eq('id', userId)\r\n\r\n    if (profileError) {\r\n        return { error: profileError.message }\r\n    }\r\n\r\n    // 2. Ban/Unban in Auth (Optional but good for security)\r\n    if (!isActive) {\r\n        const { error: banError } = await supabase.auth.admin.updateUserById(userId, {\r\n            ban_duration: '876000h', // 100 years\r\n        })\r\n        if (banError) console.error('Error banning user:', banError)\r\n    } else {\r\n        const { error: unbanError } = await supabase.auth.admin.updateUserById(userId, {\r\n            ban_duration: '0', // Remove ban\r\n        })\r\n        if (unbanError) console.error('Error unbanning user:', unbanError)\r\n    }\r\n\r\n    revalidatePath('/admin')\r\n    return { success: true }\r\n}\r\n\r\nexport async function resetUserPassword(userId: string, newPassword: string) {\r\n    const supabase = createAdminClient()\r\n\r\n    const { error } = await supabase.auth.admin.updateUserById(userId, {\r\n        password: newPassword,\r\n    })\r\n\r\n    if (error) {\r\n        return { error: error.message }\r\n    }\r\n\r\n    // Set flag to force change on next login\r\n    await supabase\r\n        .from('profiles')\r\n        .update({ must_change_password: true })\r\n        .eq('id', userId)\r\n\r\n    revalidatePath('/admin')\r\n    return { success: true }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 200, "column": 0}, "map": {"version":3,"sources":["file:///G:/SourceCode/WECORelated/weco-issue-tracker/.next-internal/server/app/admin/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {logout as '0091f46b0464e715be70c03aa0ef60514314032ae7'} from 'ACTIONS_MODULE0'\nexport {login as '40953ea532d9a9374e9cd0030d3ad0216ae7597243'} from 'ACTIONS_MODULE0'\nexport {signup as '40b8bfef349cbd5d9017a4f7e0f927d031e58600a2'} from 'ACTIONS_MODULE0'\nexport {listUsers as '009e3aec225c573daf6ea93ac419728ef3b0eed766'} from 'ACTIONS_MODULE1'\nexport {createUser as '4007e7be26b79f1cc71d94324de3a9f451eb32c450'} from 'ACTIONS_MODULE1'\nexport {resetUserPassword as '606ca896ac615554cd652870eeb07905441028a4bb'} from 'ACTIONS_MODULE1'\nexport {toggleUserStatus as '60e8da3c70f33de70527e2fc8fefaf3ca14404be14'} from 'ACTIONS_MODULE1'\nexport {createUser as '4007e7be26b79f1cc71d94324de3a9f451eb32c450'} from 'ACTIONS_MODULE1'\nexport {toggleUserStatus as '60e8da3c70f33de70527e2fc8fefaf3ca14404be14'} from 'ACTIONS_MODULE1'\nexport {resetUserPassword as '606ca896ac615554cd652870eeb07905441028a4bb'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":";AAAA;AAGA"}}]
}